#!/bin/sh

if [ "$1" == "noremount" ];then
 REMOUNT=0
else
 REMOUNT=1
fi

if ! test -e /system/etc/ram.conf; then
 echo "/system/etc/ram.conf not found"
 exit
fi

source /system/etc/ram.conf

if test $REMOUNT -eq 1; then
 if ! `/bin/mount -o remount,rw /system`; then                         
  if ! `/sbin/mount -o remount,rw /system`; then                       
   if ! `/system/xbin/mount -o remount,rw /system`; then   
    if ! `/system/bin/mount -o remount,rw /system`; then   
     if ! `mount -o remount,rw /system`; then  
      echo "Could not mount /system/etc/ rw"             
      exit                                               
 fi;fi;fi;fi;fi                                          
fi

if test -e /data/local.prop;then
 if ! `/system/xbin/busybox grep -q "" /init.rc`; then 
  echo "no grep command found - try upgrading busybox?"
  exit
 fi
 /system/xbin/busybox grep -v _APP_ /data/local.prop > /data/local.prop.tmp
 /system/xbin/busybox grep -v SECONDARY_SERVER_ /data/local.prop.tmp > /data/local.prop
 rm /data/local.prop.tmp 
fi
                                                    
echo ro.FOREGROUND_APP_ADJ=$FOREGROUND_APP_ADJ >> /data/local.prop
echo ro.VISIBLE_APP_ADJ=$VISIBLE_APP_ADJ >> /data/local.prop      
echo ro.PERCEPTIBLE_APP_ADJ=$PERCEPTIBLE_APP_ADJ >> /data/local.prop
echo ro.HEAVY_WEIGHT_APP_ADJ=$HEAVY_WEIGHT_APP_ADJ >> /data/local.prop
echo ro.SECONDARY_SERVER_ADJ=$SECONDARY_SERVER_ADJ >> /data/local.prop
echo ro.BACKUP_APP_ADJ=$BACKUP_APP_ADJ >> /data/local.prop            
echo ro.HOME_APP_ADJ=$HOME_APP_ADJ >> /data/local.prop                
echo ro.HIDDEN_APP_MIN_ADJ=$HIDDEN_APP_MIN_ADJ >> /data/local.prop            
echo ro.EMPTY_APP_ADJ=$EMPTY_APP_ADJ >> /data/local.prop              
echo ro.FOREGROUND_APP_MEM=$FOREGROUND_APP_MEM >> /data/local.prop    
echo ro.VISIBLE_APP_MEM=$VISIBLE_APP_MEM >> /data/local.prop          
echo ro.PERCEPTIBLE_APP_MEM=$PERCEPTIBLE_APP_MEM >> /data/local.prop  
echo ro.HEAVY_WEIGHT_APP_MEM=$HEAVY_WEIGHT_APP_MEM >> /data/local.prop
echo ro.SECONDARY_SERVER_MEM=$SECONDARY_SERVER_MEM >> /data/local.prop
echo ro.BACKUP_APP_MEM=$BACKUP_APP_MEM >> /data/local.prop            
echo ro.HOME_APP_MEM=$HOME_APP_MEM >> /data/local.prop                
echo ro.HIDDEN_APP_MEM=$HIDDEN_APP_MEM >> /data/local.prop            
echo ro.EMPTY_APP_MEM=$EMPTY_APP_MEM >> /data/local.prop              
                                                                      
if test -e /system/etc/init.d/_99ramset; then                 
 rm /system/etc/init.d/_99ramset                              
fi                                                                                        

for i in `/system/xbin/busybox grep -l lowmemorykiller /system/etc/init.d/*`; do
 chmod 600 $i
done 

echo "#!/system/bin/sh" > /system/etc/init.d/_99ramset 
echo "# This file is autogenerated - any changes will be overwritten. Edit /etc/ram.conf instead" >> /system/etc/init.d/_99ramset 
if ! test -z $LMK_ADJ; then echo "echo $LMK_ADJ > /sys/module/lowmemorykiller/parameters/adj" >> /system/etc/init.d/_99ramset;fi
if ! test -z $LMK_MINFREE; then echo "echo $LMK_MINFREE > /sys/module/lowmemorykiller/parameters/minfree" >> /system/etc/init.d/_99ramset;fi
if ! test -z $SWAPPINESS; then echo "echo $SWAPPINESS > /proc/sys/vm/swappiness" >> /system/etc/init.d/_99ramset;fi
if ! test -z $VFS_CACHE_PRESSURE; then echo "echo $VFS_CACHE_PRESSURE > /proc/sys/vm/vfs_cache_pressure" >> /system/etc/init.d/_99ramset;fi
if ! test -z $DIRTY_RATIO; then echo "echo $DIRTY_RATIO > /proc/sys/vm/dirty_ratio" >> /system/etc/init.d/_99ramset;fi
if ! test -z $DIRTY_BACKGROUND_RATIO; then echo "echo $DIRTY_BACKGROUND_RATIO > /proc/sys/vm/dirty_background_ratio" >> /system/etc/init.d/_99ramset;fi
if ! test -z $DIRTY_EXPIRE_CENTISECS; then echo "echo $DIRTY_EXPIRE_CENTISECS > /proc/sys/vm/dirty_expire_centisecs" >> /system/etc/init.d/_99ramset;fi
if ! test -z $DIRTY_WRITEBACK_CENTISECS; then echo "echo $DIRTY_WRITEBACK_CENTISECS > /proc/sys/vm/dirty_writeback_centisecs" >> /system/etc/init.d/_99ramset;fi
if ! test -z $LOWMEM_RESERVE_RATIO; then echo "echo $LOWMEM_RESERVE_RATIO > /proc/sys/vm/lowmem_reserve_ratio" >> /system/etc/init.d/_99ramset;fi
if ! test -z $MIN_FREE_ORDER_SHIFT; then echo "echo $MIN_FREE_ORDER_SHIFT > /proc/sys/vm/min_free_order_shift" >> /system/etc/init.d/_99ramset;fi
if ! test -z $PAGE_CLUSTER; then echo "echo $PAGE_CLUSTER > /proc/sys/vm/page-cluster" >> /system/etc/init.d/_99ramset;fi

chmod 777 /system/etc/init.d/_99ramset

if test $REMOUNT -eq 1; then
 if ! `/bin/mount -o remount,ro /system`; then
  if ! `/sbin/mount -o remount,ro /system`; then
   if ! `/system/xbin/mount -o remount,ro /system`; then
    if ! `/system/bin/mount -o remount,ro /system`; then
     mount -o remount,ro /system
 fi;fi;fi;fi
fi

